<!DOCTYPE html>
<html lang="ja">
<body>
  <h1>パスキーテスト</h1>
  <p>
    認証: <button onclick="authenticate()">認証</button>
  </p>
  <p>
    登録: <input type="text" id="name" placeholder="名前">
    <button onclick="register()">登録</button>
  </p>

  <script>
    // 認証
    async function authenticate() {
      const options = {
        challenge: new Uint8Array([1, 2, 3, 4]),
        rpId: location.hostname,
        userVerification: "discouraged",
        allowCredentials: [] // 空配列にすることで全ての保存されたパスキーを探す
      };

      try {
        const result = await navigator.credentials.get({
          publicKey: options
        });
        const name = new TextDecoder().decode(result.response.userHandle);
        alert(`認証成功: ${name}さん`);
      } catch (e) {
        alert('認証エラー: ' + e);
        console.error(e);
      }
    }

    // 登録
    async function register() {
      const name = document.getElementById('name').value;
      if (!name) {
        alert('名前を入力してください');
        return;
      }

      const options = {
        challenge: new Uint8Array([1, 2, 3, 4]),
        rp: {
          name: "テストサイト",
          id: location.hostname
        },
        user: {
          id: new TextEncoder().encode(name),
          name: name,
          displayName: name
        },
        pubKeyCredParams: [
          { type: "public-key", alg: -7 },
          { type: "public-key", alg: -257 }
        ],
        authenticatorSelection: {
          authenticatorAttachment: "platform",
          requireResidentKey: true,
          residentKey: "required"
        }
      };

      try {
        const result = await navigator.credentials.create({
          publicKey: options
        });
        alert('登録成功');
      } catch (e) {
        alert('登録エラー: ' + e);
        console.error(e);
      }
    }
  </script>
</body>
</html>
